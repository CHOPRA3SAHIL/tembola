<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Game - Online Housie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .player-input input[type="text"] {
            flex: 1;
        }

        .ticket {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .ticket-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background: white;
            font-weight: bold;
            font-size: 14px;
            border-radius: 5px;
            position: relative;
        }

        .ticket-cell.filled {
            background: #667eea;
            color: white;
        }

        .ticket-cell.marked {
            background: #4facfe !important;
            transform: scale(0.95);
        }

        .number-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .number-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .number-cell.called {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }

        .current-number {
            font-size: 4em;
            text-align: center;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .called-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .called-numbers span {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-mode-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .game-mode-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .game-mode-item input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .game-mode-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .winner-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            animation: bounceIn 0.5s;
        }

        @keyframes bounceIn {
            0% {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .winner-notification h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .winner-notification p {
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }

        .winners-list {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .winner-item strong {
            color: #667eea;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .number-board {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .ticket-grid {
                font-size: 12px;
            }

            .game-modes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎰 Tambola Game</h1>
            <p>The Classic Housie Game - Online!</p>
        </div>

        <!-- Game Setup Section -->
        <div id="setupSection" class="card">
            <h2 class="section-title">Game Setup</h2>
            
            <div class="form-group">
                <label for="numPlayers">Number of Players:</label>
                <input type="number" id="numPlayers" min="1" max="50" value="2">
            </div>

            <button class="btn" onclick="generatePlayerInputs()">Add Player Details</button>

            <div id="playerInputs" class="hidden">
                <h3 style="margin: 20px 0 10px 0;">Enter Player Details:</h3>
                <div id="playerList"></div>
                <button class="btn btn-success" onclick="generateTickets()">Generate Tickets</button>
            </div>
        </div>

        <!-- Game Modes Selection -->
        <div id="gameModesSection" class="card hidden">
            <h2 class="section-title">Select Game Modes</h2>
            <p style="margin-bottom: 20px;">Choose which winning patterns to play:</p>
            
            <div class="game-modes">
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_early5" value="early5" checked>
                    <label for="mode_early5">Early Five (First 5 numbers)</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_corners" value="corners" checked>
                    <label for="mode_corners">Four Corners</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_topLine" value="topLine" checked>
                    <label for="mode_topLine">Top Line</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_middleLine" value="middleLine" checked>
                    <label for="mode_middleLine">Middle Line</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_bottomLine" value="bottomLine" checked>
                    <label for="mode_bottomLine">Bottom Line</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_fullHouse1" value="fullHouse1" checked>
                    <label for="mode_fullHouse1">First Full House</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_fullHouse2" value="fullHouse2" checked>
                    <label for="mode_fullHouse2">Second Full House</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_fullHouse3" value="fullHouse3" checked>
                    <label for="mode_fullHouse3">Third Full House</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_breakfast" value="breakfast">
                    <label for="mode_breakfast">Breakfast (1-2-3)</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_lunch" value="lunch">
                    <label for="mode_lunch">Lunch (4-5-6)</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_dinner" value="dinner">
                    <label for="mode_dinner">Dinner (7-8-9)</label>
                </div>
                <div class="game-mode-item">
                    <input type="checkbox" id="mode_pyramid" value="pyramid">
                    <label for="mode_pyramid">Pyramid (Center column)</label>
                </div>
            </div>

            <button class="btn btn-success" onclick="confirmGameModes()">Confirm Game Modes</button>
        </div>

        <!-- Tickets Section -->
        <div id="ticketsSection" class="card hidden">
            <h2 class="section-title">Generated Tickets</h2>
            <div id="ticketsList"></div>
            <button class="btn" onclick="startGame()">Start Game</button>
            <button class="btn btn-secondary" onclick="shareAllTickets()">Share All via WhatsApp</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminSection" class="card hidden">
            <h2 class="section-title">Admin Panel - Number Calling</h2>
            
            <div class="current-number" id="currentNumber">-</div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="autoCallBtn" class="btn btn-success" onclick="toggleAutoCalling()">Start Auto Call</button>
                <button class="btn" onclick="callNextNumber()">Call Single Number</button>
                <button class="btn btn-warning" onclick="checkAllTickets()">Check Winners</button>
                <button class="btn btn-secondary" onclick="openPlayerView()">Open Player View</button>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <label for="callSpeed">Speed:</label>
                <select id="callSpeed" onchange="updateCallSpeed()" style="padding: 8px; border-radius: 5px; margin-left: 10px;">
                    <option value="3">3 seconds</option>
                    <option value="5" selected>5 seconds</option>
                    <option value="7">7 seconds</option>
                    <option value="10">10 seconds</option>
                </select>
                
                <label for="voiceType" style="margin-left: 20px;">Voice:</label>
                <select id="voiceType" onchange="updateVoiceType()" style="padding: 8px; border-radius: 5px; margin-left: 10px;">
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                </select>
                
                <label style="margin-left: 20px;">
                    <input type="checkbox" id="funMode" onchange="toggleFunMode()" style="margin-right: 5px;">
                    Fun Mode 🎉
                </label>
            </div>

            <!-- Share Game Link -->
            <div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h4 style="margin-bottom: 10px;">Share with Players:</h4>
                <div style="display: flex; gap: 10px; align-items: center; justify-content: center;">
                    <input type="text" id="gameLink" readonly style="flex: 1; max-width: 400px;" value="Open Player View to generate link">
                    <button class="btn btn-secondary" onclick="copyGameLink()">Copy Link</button>
                    <button class="btn btn-success" onclick="shareGameLink()">Share via WhatsApp</button>
                </div>
            </div>

            <!-- Active Games Display -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Active Games:</h3>
                <div id="activeGames" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>

            <h3>Number Board (1-90)</h3>
            <div class="number-board" id="numberBoard"></div>

            <h3>Called Numbers:</h3>
            <div class="called-numbers" id="calledNumbers"></div>

            <!-- Winners Section -->
            <div id="winnersSection" class="hidden">
                <h3>🏆 Winners</h3>
                <div class="winners-list" id="winnersList"></div>
            </div>
        </div>
    </div>

    <!-- Winner Notification Popup -->
    <div id="winnerOverlay" class="overlay hidden" onclick="closeWinnerNotification()"></div>
    <div id="winnerNotification" class="winner-notification hidden">
        <h2>🎉 WINNER! 🎉</h2>
        <p id="winnerMessage"></p>
        <button class="btn btn-success" onclick="shareWinnerMessage()">Share via WhatsApp</button>
        <button class="btn" onclick="closeWinnerNotification()">Close</button>
    </div>

    <script>
        let players = [];
        let tickets = [];
        let calledNumbers = [];
        let availableNumbers = [];
        let selectedGameModes = [];
        let winners = {};
        let currentWinner = null;

        // Auto-calling variables
        let autoCallInterval = null;
        let isAutoCalling = false;
        let callSpeed = 5000; // 5 seconds default
        let preferredVoiceType = 'female'; // default to female voice
        let funMode = false; // fun mode for announcements

        // Initialize available numbers
        function initializeNumbers() {
            availableNumbers = [];
            for (let i = 1; i <= 90; i++) {
                availableNumbers.push(i);
            }
        }

        // Generate player input fields
        function generatePlayerInputs() {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            for (let i = 0; i < numPlayers; i++) {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-input';
                playerDiv.innerHTML = `
                    <label>Player ${i + 1}:</label>
                    <input type="text" placeholder="Name" id="name_${i}">
                    <input type="text" placeholder="WhatsApp Number (with country code)" id="phone_${i}">
                `;
                playerList.appendChild(playerDiv);
            }

            document.getElementById('playerInputs').classList.remove('hidden');
        }

        // Generate tambola ticket
        function generateTambolaTicket() {
            const ticket = Array(3).fill(null).map(() => Array(9).fill(0));
            const columns = Array(9).fill(null).map((_, i) => {
                const start = i * 10 + (i === 0 ? 1 : 0);
                const end = i * 10 + (i === 8 ? 10 : 9);
                const nums = [];
                for (let j = start; j <= end; j++) {
                    nums.push(j);
                }
                return nums;
            });

            // Each row should have exactly 5 numbers
            for (let row = 0; row < 3; row++) {
                const positions = [];
                for (let i = 0; i < 9; i++) positions.push(i);
                
                // Shuffle positions and take first 5
                for (let i = positions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [positions[i], positions[j]] = [positions[j], positions[i]];
                }
                
                const selectedPositions = positions.slice(0, 5);
                
                selectedPositions.forEach(col => {
                    const colNums = columns[col];
                    const randomIndex = Math.floor(Math.random() * colNums.length);
                    ticket[row][col] = colNums[randomIndex];
                    colNums.splice(randomIndex, 1);
                });
            }

            return ticket;
        }

        // Generate tickets for all players
        function generateTickets() {
            players = [];
            tickets = [];
            
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            
            for (let i = 0; i < numPlayers; i++) {
                const name = document.getElementById(`name_${i}`).value || `Player ${i + 1}`;
                const phone = document.getElementById(`phone_${i}`).value;
                
                players.push({ name, phone });
                tickets.push({
                    id: i,
                    playerName: name,
                    playerPhone: phone,
                    grid: generateTambolaTicket(),
                    markedNumbers: []
                });
            }

            // Show game modes selection
            document.getElementById('gameModesSection').classList.remove('hidden');
        }

        // Confirm selected game modes
        function confirmGameModes() {
            selectedGameModes = [];
            const checkboxes = document.querySelectorAll('.game-mode-item input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedGameModes.push(checkbox.value);
            });

            if (selectedGameModes.length === 0) {
                alert('Please select at least one game mode!');
                return;
            }

            // Initialize winners tracking
            selectedGameModes.forEach(mode => {
                winners[mode] = null;
            });

            displayTickets();
            document.getElementById('ticketsSection').classList.remove('hidden');
        }

        // Display all tickets
        function displayTickets() {
            const ticketsList = document.getElementById('ticketsList');
            ticketsList.innerHTML = '';

            tickets.forEach((ticket, index) => {
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'ticket';
                ticketDiv.id = `ticket_${index}`;
                
                let ticketHTML = `
                    <div class="ticket-header">
                        <h3>${ticket.playerName}</h3>
                        <button class="btn btn-secondary" onclick="shareTicket(${index})">Share via WhatsApp</button>
                    </div>
                    <div class="ticket-grid" id="ticketGrid_${index}">
                `;

                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 9; col++) {
                        const num = ticket.grid[row][col];
                        const cellId = `cell_${index}_${row}_${col}`;
                        ticketHTML += `<div class="ticket-cell ${num ? 'filled' : ''}" id="${cellId}" data-number="${num}">${num || ''}</div>`;
                    }
                }

                ticketHTML += '</div></div>';
                ticketDiv.innerHTML = ticketHTML;
                ticketsList.appendChild(ticketDiv);
            });
        }

        // Share individual ticket via WhatsApp
        function shareTicket(index) {
            const ticket = tickets[index];
            if (!ticket.playerPhone) {
                alert('Please provide WhatsApp number for this player');
                return;
            }

            let message = `🎰 TAMBOLA TICKET\n`;
            message += `Player: ${ticket.playerName}\n\n`;
            message += `Your Ticket:\n`;
            
            for (let row = 0; row < 3; row++) {
                let rowText = '';
                for (let col = 0; col < 9; col++) {
                    const num = ticket.grid[row][col];
                    rowText += num ? `[${num.toString().padStart(2, ' ')}]` : '[  ]';
                }
                message += rowText + '\n';
            }
            
            message += `\nActive Games:\n`;
            selectedGameModes.forEach(mode => {
                message += `• ${getGameModeName(mode)}\n`;
            });
            
            message += `\nGood luck! 🍀`;

            // Remove any non-numeric characters from phone number except +
            const cleanPhone = ticket.playerPhone.replace(/[^\d+]/g, '');
            
            // Create WhatsApp URL
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Get game mode display name
        function getGameModeName(mode) {
            const names = {
                early5: "Early Five",
                corners: "Four Corners",
                topLine: "Top Line",
                middleLine: "Middle Line",
                bottomLine: "Bottom Line",
                fullHouse1: "First Full House",
                fullHouse2: "Second Full House",
                fullHouse3: "Third Full House",
                breakfast: "Breakfast (1-2-3)",
                lunch: "Lunch (4-5-6)",
                dinner: "Dinner (7-8-9)",
                pyramid: "Pyramid"
            };
            return names[mode] || mode;
        }

        // Share all tickets
        function shareAllTickets() {
            tickets.forEach((_, index) => {
                setTimeout(() => shareTicket(index), index * 1000);
            });
        }

        // Start the game
        function startGame() {
            initializeNumbers();
            calledNumbers = [];
            
            // Create number board
            const numberBoard = document.getElementById('numberBoard');
            numberBoard.innerHTML = '';
            
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                cell.id = `num_${i}`;
                cell.textContent = i;
                numberBoard.appendChild(cell);
            }

            // Display active games
            const activeGamesDiv = document.getElementById('activeGames');
            activeGamesDiv.innerHTML = '';
            selectedGameModes.forEach(mode => {
                const span = document.createElement('span');
                span.style.cssText = 'background: #667eea; color: white; padding: 5px 15px; border-radius: 20px;';
                span.textContent = getGameModeName(mode);
                activeGamesDiv.appendChild(span);
            });

            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('currentNumber').textContent = '-';
            document.getElementById('calledNumbers').innerHTML = '';
        }

        // Mark number on tickets
        function markNumberOnTickets(number) {
            tickets.forEach((ticket, ticketIndex) => {
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (ticket.grid[row][col] === number) {
                            ticket.markedNumbers.push(number);
                            const cell = document.getElementById(`cell_${ticketIndex}_${row}_${col}`);
                            if (cell) {
                                cell.classList.add('marked');
                            }
                        }
                    }
                }
            });
        }

        // Check all tickets for winners
        function checkAllTickets() {
            tickets.forEach((ticket, index) => {
                checkTicketForWins(ticket, index);
            });
        }

        // Check individual ticket for wins
        function checkTicketForWins(ticket, ticketIndex) {
            selectedGameModes.forEach(mode => {
                if (!winners[mode] && checkWinCondition(ticket, mode)) {
                    winners[mode] = {
                        playerName: ticket.playerName,
                        playerPhone: ticket.playerPhone,
                        ticketIndex: ticketIndex,
                        mode: mode
                    };
                    announceWinner(ticket, mode);
                }
            });
        }

        // Check win condition for a specific mode
        function checkWinCondition(ticket, mode) {
            const marked = ticket.markedNumbers;
            const grid = ticket.grid;

            switch (mode) {
                case 'early5':
                    return marked.length >= 5;
                
                case 'corners':
                    const corners = [];
                    // Find corners
                    for (let row = 0; row < 3; row++) {
                        let firstCol = -1, lastCol = -1;
                        for (let col = 0; col < 9; col++) {
                            if (grid[row][col] !== 0) {
                                if (firstCol === -1) firstCol = col;
                                lastCol = col;
                            }
                        }
                        if (row === 0 || row === 2) {
                            if (firstCol !== -1) corners.push(grid[row][firstCol]);
                            if (lastCol !== -1 && lastCol !== firstCol) corners.push(grid[row][lastCol]);
                        }
                    }
                    return corners.length === 4 && corners.every(num => marked.includes(num));
                
                case 'topLine':
                    return checkLine(grid[0], marked);
                
                case 'middleLine':
                    return checkLine(grid[1], marked);
                
                case 'bottomLine':
                    return checkLine(grid[2], marked);
                
                case 'fullHouse1':
                case 'fullHouse2':
                case 'fullHouse3':
                    const allNumbers = [];
                    grid.forEach(row => {
                        row.forEach(num => {
                            if (num !== 0) allNumbers.push(num);
                        });
                    });
                    return allNumbers.every(num => marked.includes(num));
                
                case 'breakfast':
                    return [1, 2, 3].every(num => marked.includes(num));
                
                case 'lunch':
                    return [4, 5, 6].every(num => marked.includes(num));
                
                case 'dinner':
                    return [7, 8, 9].every(num => marked.includes(num));
                
                case 'pyramid':
                    const centerCol = [];
                    for (let row = 0; row < 3; row++) {
                        if (grid[row][4] !== 0) {
                            centerCol.push(grid[row][4]);
                        }
                    }
                    return centerCol.length > 0 && centerCol.every(num => marked.includes(num));
                
                default:
                    return false;
            }
        }

        // Check if line is complete
        function checkLine(line, marked) {
            const lineNumbers = line.filter(num => num !== 0);
            return lineNumbers.length > 0 && lineNumbers.every(num => marked.includes(num));
        }

        // Announce winner
        function announceWinner(ticket, mode) {
            currentWinner = {
                playerName: ticket.playerName,
                playerPhone: ticket.playerPhone,
                mode: mode
            };

            // Show winner notification
            document.getElementById('winnerMessage').innerHTML = `
                <strong>${ticket.playerName}</strong> won<br>
                <span style="font-size: 1.5em; color: #667eea;">${getGameModeName(mode)}</span>
            `;
            document.getElementById('winnerOverlay').classList.remove('hidden');
            document.getElementById('winnerNotification').classList.remove('hidden');

            // Add to winners list
            updateWinnersList();

            // Voice announcement
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(`Congratulations! ${ticket.playerName} has won ${getGameModeName(mode)}!`);
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            }
        }

        // Update winners list display
        function updateWinnersList() {
            const winnersSection = document.getElementById('winnersSection');
            const winnersList = document.getElementById('winnersList');
            
            winnersSection.classList.remove('hidden');
            winnersList.innerHTML = '';

            Object.entries(winners).forEach(([mode, winner]) => {
                if (winner) {
                    const winnerDiv = document.createElement('div');
                    winnerDiv.className = 'winner-item';
                    winnerDiv.innerHTML = `
                        <div>
                            <strong>${getGameModeName(mode)}</strong>: ${winner.playerName}
                        </div>
                        <button class="btn btn-secondary" onclick="shareWinnerToPlayer('${mode}')">Notify</button>
                    `;
                    winnersList.appendChild(winnerDiv);
                }
            });
        }

        // Close winner notification
        function closeWinnerNotification() {
            document.getElementById('winnerOverlay').classList.add('hidden');
            document.getElementById('winnerNotification').classList.add('hidden');
            currentWinner = null;
        }

        // Share winner message
        function shareWinnerMessage() {
            if (!currentWinner) return;
            shareWinnerToPlayer(currentWinner.mode);
            closeWinnerNotification();
        }

        // Share winner notification to player
        function shareWinnerToPlayer(mode) {
            const winner = winners[mode];
            if (!winner || !winner.playerPhone) {
                alert('No phone number available for this winner');
                return;
            }

            const message = `🎉 CONGRATULATIONS! 🎉\n\nYou have WON ${getGameModeName(mode)} in our Tambola game!\n\n🏆 Well done, ${winner.playerName}! 🏆`;
            
            const cleanPhone = winner.playerPhone.replace(/[^\d+]/g, '');
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Toggle auto calling
        function toggleAutoCalling() {
            if (isAutoCalling) {
                stopAutoCalling();
            } else {
                startAutoCalling();
            }
        }

        // Start auto calling
        function startAutoCalling() {
            if (availableNumbers.length === 0) {
                alert('All numbers have been called!');
                return;
            }

            isAutoCalling = true;
            document.getElementById('autoCallBtn').textContent = 'Stop Auto Call';
            document.getElementById('autoCallBtn').classList.add('btn-secondary');
            
            // Call first number immediately
            callNextNumber();
            
            // Set interval for subsequent calls
            autoCallInterval = setInterval(() => {
                if (availableNumbers.length === 0) {
                    stopAutoCalling();
                    alert('All numbers have been called!');
                    return;
                }
                callNextNumber();
            }, callSpeed);
        }

        // Stop auto calling
        function stopAutoCalling() {
            isAutoCalling = false;
            document.getElementById('autoCallBtn').textContent = 'Start Auto Call';
            document.getElementById('autoCallBtn').classList.remove('btn-secondary');
            
            if (autoCallInterval) {
                clearInterval(autoCallInterval);
                autoCallInterval = null;
            }
        }

        // Update call speed
        function updateCallSpeed() {
            callSpeed = parseInt(document.getElementById('callSpeed').value) * 1000;
            if (isAutoCalling) {
                stopAutoCalling();
                startAutoCalling();
            }
        }

        // Update voice type
        function updateVoiceType() {
            preferredVoiceType = document.getElementById('voiceType').value;
        }

        // Toggle fun mode
        function toggleFunMode() {
            funMode = document.getElementById('funMode').checked;
        }

        // Get fun calls for numbers
        function getFunCall(number) {
            const funCalls = {
                1: "Single and ready to mingle",
                2: "Two's company, three's a crowd",
                3: "Three musketeers",
                4: "Fantastic four",
                5: "High five everybody",
                6: "Six pack abs",
                7: "Seven days a week, still no weekend",
                8: "Eight, don't be late",
                9: "Cloud nine feeling fine",
                10: "Perfect ten, just like you",
                11: "Eleven, legs like Eleven from Stranger Things",
                12: "Dozen roses for my poses",
                13: "Unlucky for some, lucky for you",
                14: "Valentine's day",
                15: "Fifteen minutes of fame",
                16: "Sweet sixteen and never been kissed",
                17: "Dancing queen, seventeen",
                18: "Finally legal, eighteen",
                19: "Last of the teens",
                20: "Twenty twenty vision",
                21: "Twenty one, let's have some fun",
                22: "Two ducks having a chat",
                23: "Twenty three, Michael Jordan's legacy",
                24: "Hours in a day, still not enough",
                25: "Quarter of a century",
                26: "Twenty six, Netflix and chill",
                27: "Twenty seven, gateway to heaven",
                28: "Twenty eight, don't be late for your date",
                29: "Twenty nine, feeling fine like wine",
                30: "Thirty, flirty and thriving",
                31: "Thirty one, day's done",
                32: "Thirty two, buckle my shoe",
                33: "Thirty three, all the threes",
                34: "Thirty four, knock at the door for more",
                35: "Thirty five, still alive and ready to jive",
                36: "Three dozen, cousin",
                37: "Thirty seven, stairway to heaven",
                38: "Thirty eight, don't be late mate",
                39: "Thirty nine, doing fine with wine",
                40: "Life begins at forty",
                41: "Forty one, time for fun",
                42: "Answer to life, universe and everything",
                43: "Forty three, cup of tea",
                44: "All the fours, open the doors",
                45: "Halfway to ninety",
                46: "Forty six, up to tricks",
                47: "Forty seven, AK forty seven",
                48: "Four dozen eggs",
                49: "Forty nine, looking fine",
                50: "Half century, golden jubilee",
                51: "Fifty one, party's begun",
                52: "Deck of cards, fifty two",
                53: "Fifty three, wild and free",
                54: "Fifty four, clean the floor",
                55: "Speed limit, double nickels",
                56: "Fifty six, pick up sticks",
                57: "Heinz varieties",
                58: "Fifty eight, don't be late",
                59: "Fifty nine, feeling fine",
                60: "Five dozen, retirement cousin",
                61: "Sixty one, baker's bun",
                62: "Sixty two, turn the screw",
                63: "Sixty three, tickle me knee",
                64: "Nintendo sixty four",
                65: "Old age pension time",
                66: "Route sixty six, get your kicks",
                67: "Sixty seven, made in heaven",
                68: "Sixty eight, saving is great",
                69: "Sixty nine, everything's fine",
                70: "Three score and ten",
                71: "Seventy one, lucky one",
                72: "Six dozen, par for the course",
                73: "Seventy three, lucky me",
                74: "Seventy four, knock at the door",
                75: "Diamond jubilee, seventy five",
                76: "Seventy six, lucky tricks",
                77: "Two sevens, sunset strip heaven",
                78: "Seventy eight, heaven's gate",
                79: "Seventy nine, one more time",
                80: "Eight zero, Gandhi's hero",
                81: "Eighty one, stop and run",
                82: "Eighty two, straight down the loo",
                83: "Eighty three, time for tea",
                84: "Eighty four, seven dozen more",
                85: "Staying alive at eighty five",
                86: "Eighty six, between the sticks",
                87: "Eighty seven, torquay in devon",
                88: "Two fat ladies going on a date",
                89: "Nearly there, eighty nine",
                90: "Top of the shop, that's the lot"
            };

            return funCalls[number] || `Number ${number}`;
        }

        // Call next number
        function callNextNumber() {
            if (availableNumbers.length === 0) {
                if (isAutoCalling) {
                    stopAutoCalling();
                }
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const number = availableNumbers[randomIndex];
            availableNumbers.splice(randomIndex, 1);
            
            calledNumbers.push(number);
            
            // Update display with animation
            const currentNumElement = document.getElementById('currentNumber');
            currentNumElement.style.transform = 'scale(1.2)';
            currentNumElement.textContent = number;
            setTimeout(() => {
                currentNumElement.style.transform = 'scale(1)';
            }, 300);
            
            document.getElementById(`num_${number}`).classList.add('called');
            
            // Update called numbers list
            const calledDiv = document.getElementById('calledNumbers');
            const span = document.createElement('span');
            span.textContent = number;
            calledDiv.appendChild(span);

            // Mark number on all tickets
            markNumberOnTickets(number);

            // Check for winners after marking
            checkAllTickets();

            // Announce number with voice
            announceNumber(number);
            
            // Update shared game state for player view
            updateSharedGameState();
        }

        // Announce number with special calls
        function announceNumber(number) {
            const traditionalCalls = {
                1: "Kelly's eye",
                2: "One little duck",
                3: "Cup of tea",
                4: "Knock at the door",
                5: "Man alive",
                7: "Lucky seven",
                8: "Garden gate",
                10: "Boris's den",
                11: "Legs eleven",
                13: "Unlucky for some",
                16: "Sweet sixteen",
                18: "Coming of age",
                21: "Royal salute",
                22: "Two little ducks",
                25: "Duck and dive",
                30: "Dirty Gertie",
                33: "Dirty knee",
                40: "Life begins",
                50: "Half a century",
                60: "Five dozen",
                66: "Clickety click",
                70: "Three score and ten",
                77: "Sunset strip",
                80: "Eight and blank",
                88: "Two fat ladies",
                90: "Top of the shop"
            };

            const call = funMode ? getFunCall(number) : (traditionalCalls[number] || `Number ${number}`);
            
            // Always use speech synthesis for announcements
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance();
                utterance.text = `${call}... ${number}`;
                utterance.rate = funMode ? 0.85 : 0.9;
                utterance.volume = 1;
                
                // Get all available voices
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    let selectedVoice = null;
                    
                    // Filter English voices
                    const englishVoices = voices.filter(voice => 
                        voice.lang.startsWith('en-') || voice.lang === 'en'
                    );
                    
                    if (preferredVoiceType === 'female') {
                        // Female voice indicators
                        selectedVoice = englishVoices.find(voice => {
                            const name = voice.name.toLowerCase();
                            return name.includes('female') || 
                                   name.includes('woman') ||
                                   name.includes('samantha') ||
                                   name.includes('victoria') ||
                                   name.includes('karen') ||
                                   name.includes('susan') ||
                                   name.includes('zira') || // Windows
                                   name.includes('helena') ||
                                   name.includes('hazel') ||
                                   name.includes('linda') ||
                                   name.includes('zoey') ||
                                   name.includes('nicky') ||
                                   name.includes('google uk english female') ||
                                   name.includes('google us english female') ||
                                   name.includes('microsoft zira') ||
                                   name.includes('microsoft eva') ||
                                   name.includes('fiona') ||
                                   name.includes('alice') ||
                                   name.includes('alva') ||
                                   name.includes('amelie') ||
                                   name.includes('anna') ||
                                   name.includes('carmit') ||
                                   name.includes('damayanti') ||
                                   name.includes('ellen') ||
                                   name.includes('ioana') ||
                                   name.includes('joana') ||
                                   name.includes('kanya') ||
                                   name.includes('kate') ||
                                   name.includes('kiyara') ||
                                   name.includes('laura') ||
                                   name.includes('lekha') ||
                                   name.includes('lesya') ||
                                   name.includes('marie') ||
                                   name.includes('martha') ||
                                   name.includes('melina') ||
                                   name.includes('milena') ||
                                   name.includes('moira') ||
                                   name.includes('monica') ||
                                   name.includes('nora') ||
                                   name.includes('paulina') ||
                                   name.includes('sara') ||
                                   name.includes('satu') ||
                                   name.includes('serena') ||
                                   name.includes('sinji') ||
                                   name.includes('tessa') ||
                                   name.includes('veena') ||
                                   name.includes('vicki') ||
                                   name.includes('yelda') ||
                                   name.includes('yuna') ||
                                   name.includes('zosia') ||
                                   name.includes('zuzana');
                        });
                        
                        // Set higher pitch for female voice
                        utterance.pitch = 1.2;
                    } else {
                        // Male voice indicators
                        selectedVoice = englishVoices.find(voice => {
                            const name = voice.name.toLowerCase();
                            return name.includes('male') || 
                                   name.includes('man') ||
                                   name.includes('daniel') ||
                                   name.includes('james') ||
                                   name.includes('oliver') ||
                                   name.includes('david') || // Windows
                                   name.includes('mark') ||
                                   name.includes('aaron') ||
                                   name.includes('fred') ||
                                   name.includes('carlos') ||
                                   name.includes('diego') ||
                                   name.includes('felipe') ||
                                   name.includes('gordon') ||
                                   name.includes('lee') ||
                                   name.includes('otoya') ||
                                   name.includes('rishi') ||
                                   name.includes('tom') ||
                                   name.includes('alex');
                        });
                        
                        // Set lower pitch for male voice
                        utterance.pitch = 0.9;
                    }
                    
                    // Fallback logic
                    if (!selectedVoice && englishVoices.length > 0) {
                        // Try to pick based on voice index
                        if (preferredVoiceType === 'female') {
                            selectedVoice = englishVoices[0]; // Usually female
                        } else {
                            selectedVoice = englishVoices[englishVoices.length > 1 ? 1 : 0];
                        }
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        // Initialize the game
        initializeNumbers();
        
        // Load voices for speech synthesis
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            // Some browsers need this event to load voices
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }

        // Player View Functions
        function openPlayerView() {
            // Store game state in localStorage for player view
            const gameState = {
                currentNumber: document.getElementById('currentNumber').textContent,
                calledNumbers: calledNumbers,
                activeGames: selectedGameModes,
                winners: winners
            };
            localStorage.setItem('tambolaGameState', JSON.stringify(gameState));
            
            // Open player view in new window
            const playerWindow = window.open('', 'TambolaPlayerView', 'width=1200,height=800');
            playerWindow.document.write(generatePlayerViewHTML());
            
            // Update the share link
            document.getElementById('gameLink').value = 'Share your screen or use screen sharing apps';
        }

        function copyGameLink() {
            const linkInput = document.getElementById('gameLink');
            linkInput.select();
            document.execCommand('copy');
            alert('Link copied! (Note: For live updates, use screen sharing)');
        }

        function shareGameLink() {
            const message = `🎰 Join our Tambola Game!\n\nTo see live numbers:\n1. Join our video call\n2. Or ask admin to share screen\n\nActive Games:\n${selectedGameModes.map(mode => '• ' + getGameModeName(mode)).join('\n')}\n\nGood luck! 🍀`;
            
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function generatePlayerViewHTML() {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola - Player View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 900px;
            width: 90%;
        }
        .game-title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 30px;
        }
        .current-number-display {
            font-size: 8em;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .called-numbers-display {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .called-numbers-display h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 30px;
        }
        .number-box {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
        }
        .number-box.called {
            background: #667eea;
            color: white;
            transform: scale(0.95);
        }
        .refresh-note {
            margin-top: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1 class="game-title">🎰 Tambola Live Numbers</h1>
        
        <div class="current-number-display" id="playerCurrentNumber">-</div>
        
        <div class="called-numbers-display">
            <h3>Called Numbers</h3>
            <div id="playerCalledNumbers"></div>
        </div>
        
        <div class="number-grid" id="playerNumberGrid"></div>
        
        <p class="refresh-note">Refresh page to update • For live updates, join the video call</p>
    </div>

    <script>
        // Load game state
        const gameState = JSON.parse(localStorage.getItem('tambolaGameState') || '{}');
        
        // Display current number
        document.getElementById('playerCurrentNumber').textContent = gameState.currentNumber || '-';
        
        // Display called numbers
        const calledDiv = document.getElementById('playerCalledNumbers');
        if (gameState.calledNumbers && gameState.calledNumbers.length > 0) {
            calledDiv.innerHTML = gameState.calledNumbers.map(num => 
                '<span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 20px; margin: 5px; display: inline-block;">' + num + '</span>'
            ).join('');
        } else {
            calledDiv.innerHTML = '<p>No numbers called yet</p>';
        }
        
        // Create number grid
        const gridDiv = document.getElementById('playerNumberGrid');
        for (let i = 1; i <= 90; i++) {
            const box = document.createElement('div');
            box.className = 'number-box';
            if (gameState.calledNumbers && gameState.calledNumbers.includes(i)) {
                box.classList.add('called');
            }
            box.textContent = i;
            gridDiv.appendChild(box);
        }
        
        // Auto refresh every 5 seconds
        setInterval(() => {
            location.reload();
        }, 5000);
    </` + `script>
</body>
</html>`;
        }

        // Update game state in localStorage when number is called
        function updateSharedGameState() {
            const gameState = {
                currentNumber: document.getElementById('currentNumber').textContent,
                calledNumbers: calledNumbers,
                activeGames: selectedGameModes,
                winners: winners
            };
            localStorage.setItem('tambolaGameState', JSON.stringify(gameState));
        }
    </script>
</body>
</html>
